= Proven HTTP - Formally Verified HTTP Utilities
:toc: macro
:icons: font
:idprefix:
:idseparator: -

image:https://img.shields.io/badge/Made%20with-Idris2-blue?logo=data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiAyMkgyMkwxMiAyWiIgZmlsbD0iIzAwN2VjNiIvPgo8L3N2Zz4K[Made with Idris2,link=https://www.idris-lang.org/]
image:https://img.shields.io/badge/License-MPL_2.0-blue.svg[MPL-2.0-or-later,link="https://opensource.org/licenses/MPL-2.0"]
image:https://img.shields.io/badge/Language-Ada%2FSPARK-blue.svg[Ada/SPARK]
image:https://img.shields.io/badge/FFI-Zig-orange.svg[Zig FFI]

== License & Philosophy

This project must declare **MPL-2.0-or-later** for platform/tooling compatibility.

Philosophy: **Palimpsest**. The Palimpsest-MPL (PMPL) text is provided in `license/PMPL-1.0.txt`, and the canonical source is the palimpsest-license repository.

**Formally verified HTTP utilities with Ada/SPARK bindings.**

Proven HTTP provides cryptographically sound HTTP operations backed by formal verification in Idris2. The verification chain flows through Zig FFI to Ada/SPARK bindings, ensuring type safety and correctness at every layer.

toc::[]

== Features

* **RFC 3986 URL Encoding/Decoding** - Percent encoding with formal correctness guarantees
* **Zero Runtime Errors** - SPARK-verified Ada code proven free of exceptions
* **Formally Verified Core** - Idris2 dependent types prove algorithmic correctness
* **Memory Safe FFI** - Zig provides safe C ABI boundary
* **Type Safe** - Ada strong typing catches errors at compile time

== Architecture

[source]
----
Idris2 (Formal Proofs)
  ↓
Zig FFI (C ABI Layer)
  ↓
Ada/SPARK Bindings
  ↓
Your Application
----

=== Verification Chain

1. **Idris2 Layer** (`src/Proven/SafeHTTP.idr`)
   - Dependent types encode correctness properties
   - `%default total` ensures all functions terminate
   - URL encoding proven to preserve unreserved characters

2. **Zig FFI Layer** (`ffi/zig/src/`)
   - Exports C ABI-compatible functions
   - Safe string marshalling
   - Memory management with RAII

3. **Ada/SPARK Bindings** (`bindings/ada/src/`)
   - SPARK contracts (Pre/Post conditions)
   - Global annotations (no hidden state)
   - Integration with Ada applications

== Installation

=== Using Alire (Ada Package Manager)

[source,bash]
----
alr get proven_http
alr with proven_http
----

=== Manual Installation

[source,bash]
----
git clone https://github.com/hyperpolymath/proven-http.git
cd proven-http/bindings/ada
gprbuild -P proven_http.gpr
----

== Usage

=== URL Encoding

[source,ada]
----
with Proven.Safe_HTTP.URL;

procedure Example is
   Original : constant String := "hello world!";
   Encoded  : constant String := Proven.Safe_HTTP.URL.URL_Encode (Original);
   Decoded  : constant String := Proven.Safe_HTTP.URL.URL_Decode (Encoded);
begin
   --  Encoded = "hello%20world%21"
   --  Decoded = "hello world!"
   null;
end Example;
----

=== Unreserved Character Check

[source,ada]
----
with Proven.Safe_HTTP.URL;

function Is_Safe (C : Character) return Boolean is
begin
   return Proven.Safe_HTTP.URL.Is_Unreserved (C);
   --  Returns True for: A-Z, a-z, 0-9, -, _, ., ~
end Is_Safe;
----

=== Validation

[source,ada]
----
with Proven.Safe_HTTP.URL;

procedure Validate is
   URL : constant String := "https://example.com/path%20with%20spaces";
begin
   if Proven.Safe_HTTP.URL.Is_Valid_Encoded (URL) then
      --  URL is properly percent-encoded
      null;
   end if;
end Validate;
----

== API Reference

=== `Proven.Safe_HTTP.URL`

[source,ada]
----
package Proven.Safe_HTTP.URL is

   --  Encode string using RFC 3986 percent encoding
   function URL_Encode (Input : String) return String
   with Global => null,
        Post   => URL_Encode'Result'Length >= Input'Length;

   --  Decode percent-encoded string
   --  Returns empty string if encoding is invalid
   function URL_Decode (Input : String) return String
   with Global => null;

   --  Check if character is unreserved (doesn't need encoding)
   function Is_Unreserved (C : Character) return Boolean
   with Global => null, Inline;

   --  Validate percent-encoding
   function Is_Valid_Encoded (Input : String) return Boolean
   with Global => null;

end Proven.Safe_HTTP.URL;
----

== Formal Verification

=== Idris2 Proofs

The core `urlEncode` function in `src/Proven/SafeHTTP.idr` is proven to:

1. **Preserve unreserved characters** - Characters in `[A-Za-z0-9-_.~]` pass through unchanged
2. **Always terminate** - `%default total` checked by Idris2
3. **Produce valid output** - All percent-encoded sequences are valid `%XX` hex

Example proof snippet:

[source,idris]
----
public export
urlEncode : String -> String
urlEncode s =
  concat $ map (\c => if isUnreserved c
                       then singleton c
                       else percentEncode c)
              (unpack s)
----

The `%default total` pragma forces Idris2 to verify termination - this function will never loop infinitely.

=== SPARK Contracts

Ada bindings include SPARK contracts for runtime verification:

[source,ada]
----
function URL_Encode (Input : String) return String
with Global => null,  --  No hidden state
     Post   => URL_Encode'Result'Length >= Input'Length;
     --  Output is at least as long as input (due to escaping)
----

== Building from Source

=== Prerequisites

* **Idris2** ≥ 0.7.0 (for formal verification layer)
* **Zig** ≥ 0.11.0 (for FFI layer)
* **GNAT** ≥ 13.0 or **Alire** (for Ada bindings)
* **GNATprove** (optional, for SPARK verification)

=== Build Steps

[source,bash]
----
# 1. Build Idris2 module
cd src
idris2 --build proven-http.ipkg

# 2. Build Zig FFI
cd ../ffi/zig
zig build

# 3. Build Ada bindings
cd ../../bindings/ada
gprbuild -P proven_http.gpr

# 4. Run SPARK proofs (optional)
gnatprove -P proven_http.gpr
----

== Integration Example

=== Cerro Torre HTTP Client

Proven HTTP is extracted from the https://github.com/hyperpolymath/cerro-torre[Cerro Torre] project, which uses it for OCI registry operations:

[source,ada]
----
with Proven.Safe_HTTP.URL;

function Build_Registry_URL
  (Registry   : String;
   Repository : String;
   Tag        : String) return String
is
   Encoded_Repo : constant String :=
     Proven.Safe_HTTP.URL.URL_Encode (Repository);
   Encoded_Tag  : constant String :=
     Proven.Safe_HTTP.URL.URL_Encode (Tag);
begin
   return "https://" & Registry & "/v2/" &
          Encoded_Repo & "/manifests/" & Encoded_Tag;
end Build_Registry_URL;
----

== Comparison with Alternatives

[%header,cols="2,1,1,1,1"]
|===
|Library |Formal Verification |Memory Safety |Type Safety |Standards Compliance

|**Proven HTTP**
|✅ Idris2 + SPARK
|✅ Zig + Ada
|✅ Strong
|✅ RFC 3986

|GNAT.Sockets
|❌
|✅ Ada
|✅ Strong
|Partial

|AWS (Ada Web Server)
|❌
|✅ Ada
|✅ Strong
|✅

|libcurl (C)
|❌
|⚠️ Manual
|❌ Weak
|✅

|Go net/http
|❌
|✅ GC
|⚠️ Moderate
|✅
|===

== License

**PMPL-1.0-or-later** (Palimpsest Mozilla Public License)

Based on MPL-2.0 with ethical use and provenance extensions.

See link:LICENSE[LICENSE] file for complete terms.

== Contributing

Contributions welcome! Please ensure:

1. **Idris2 proofs pass** - All functions must be `%default total`
2. **Zig compiles** - `zig build` succeeds with no warnings
3. **SPARK verification** - `gnatprove` finds no violations
4. **Tests pass** - Ada unit tests succeed

== Acknowledgments

* **Idris2** - Edwin Brady and the Idris community
* **Zig** - Andrew Kelley and Zig contributors
* **GNAT/SPARK** - AdaCore for formal verification tooling
* **Cerro Torre** - Original integration context

== Links

* **Main Proven Library**: https://github.com/hyperpolymath/proven
* **Cerro Torre** (integration example): https://github.com/hyperpolymath/cerro-torre
* **RFC 3986**: https://www.rfc-editor.org/rfc/rfc3986.html
* **Idris2**: https://www.idris-lang.org/
* **SPARK**: https://www.adacore.com/about-spark

---

**Made with ❤️ and formal verification**
